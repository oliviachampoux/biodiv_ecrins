<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Biodiversité Parc Écrins</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <!-- MarkerCluster CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>

  <style>
    html, body { height: 100%; margin: 0; padding: 0; }
    #map { height: 100%; width: 100%; position: relative; }

    /* Bandeau titre blanc, texte noir, 16px, moins large */
    #mapTitle {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      background: rgba(255, 255, 255, 0.9);
      color: #000;
      padding: 6px 12px;
      font-family: Arial, sans-serif;
      font-size: 14px;
      font-weight: bold;
      text-align: center;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.25);
      max-width: 80%;
      white-space: nowrap;
    }

    /* Légende */
    .legend {
      background: white;
      padding: 12px 14px;
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.25);
      font-family: Arial, sans-serif;
      font-size: 14px;
      line-height: 18px;
      min-width: 220px;
    }

    .legend-row { display: flex; align-items: center; gap: 10px; margin: 6px 0; }
    .legend-dot {
      width: 10px; height: 10px; border-radius: 50%;
      background: #000; border: 1px solid #fff; box-sizing: border-box;
    }
    .legend-label { flex: 1; }
    .legend-checkbox { transform: scale(1.05); cursor: pointer; }

    /* Barre dégradée pour la grille */
    .legend-gradient {
      width: 100%;
      height: 16px;
      border-radius: 4px;
      background: linear-gradient(to right, #fee0d2, #fc9272, #fb6a4a, #ef3b2c, #cb181d, #99000d);
      margin: 6px 0 0 0;
      border: 1px solid rgba(0,0,0,0.35);
    }

    .legend-gradient-labels {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      margin-top: 2px;
    }
  </style>
</head>

<body>
  <div id="map">
    <div id="mapTitle">Biodiversité observée au Parc National des Écrins en 2024</div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <script>
    // Carte + OSM
    const map = L.map("map").setView([44.92, 6.35], 10);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);

    // Points en cluster
    const pointStyle = { radius: 3, fillColor: "#000", color: "#fff", weight: 1, opacity: 1, fillOpacity: 0.9 };
    function makePopupContent(props) {
      return `
        <div style="font-family: Arial; font-size: 14px;">
          <b>Nom vernaculaire :</b> ${props.nom_vern ?? "—"}<br>
          <b>Nom valide :</b> ${props.nom_valide ?? "—"}<br>
          <b>Règne :</b> ${props.regne ?? "—"}<br>
          <b>Classe :</b> ${props.classe ?? "—"}<br>
          <b>Ordre :</b> ${props.ordre ?? "—"}<br>
          <b>Famille :</b> ${props.famille ?? "—"}<br>
        </div>
      `;
    }
    const clusterGroup = L.markerClusterGroup({ disableClusteringAtZoom:16, spiderfyOnMaxZoom:true, showCoverageOnHover:false });

    // Grille polygones
    let gridLayer = null;
    function getGridColor(total) {
      if (total <= 5) return "#fee0d2";
      if (total <= 15) return "#fc9272";
      if (total <= 40) return "#fb6a4a";
      if (total <= 80) return "#ef3b2c";
      if (total <= 150) return "#cb181d";
      return "#99000d";
    }
    function gridStyle(feature) {
      const total = Number(feature?.properties?.total ?? 0);
      return { fillColor: getGridColor(total), fillOpacity:0.85, color:"#000", weight:0.5, opacity:0.3 };
    }

    const layersLoaded = { points:false, grid:false };
    function tryFitBounds() {
      if(layersLoaded.points && layersLoaded.grid) {
        const group = L.featureGroup([clusterGroup, gridLayer]);
        map.fitBounds(group.getBounds());
      }
    }

    // Charger points.geoJSON
    fetch("https://github.com/oliviachampoux/biodiv_ecrins/blob/main/points.geojson").then(r=>r.ok?r.json():Promise.reject("Impossible de charger points.geoJSON"))
      .then(data=>{
        const geojsonPoints = L.geoJSON(data, {
          pointToLayer: (f, latlng)=>{
            const m=L.circleMarker(latlng, pointStyle);
            if(f.properties) m.bindPopup(makePopupContent(f.properties));
            return m;
          }
        });
        clusterGroup.addLayer(geojsonPoints);
        map.addLayer(clusterGroup);
        layersLoaded.points=true;
        tryFitBounds();
      }).catch(err=>console.error(err));

    // Charger grille.geojson
    fetch("https://raw.githubusercontent.com/oliviachampoux/biodiv_ecrins/refs/heads/main/grille.geojson").then(r=>r.ok?r.json():Promise.reject("Impossible de charger grille.geojson"))
      .then(data=>{
        gridLayer = L.geoJSON(data,{ style:gridStyle, interactive:false });
        gridLayer.addTo(map);
        layersLoaded.grid=true;
        tryFitBounds();
      }).catch(err=>console.error(err));

    // Légende avec gradient
    const legend = L.control({ position:"bottomright" });
    legend.onAdd = function(){
      const div=L.DomUtil.create("div","legend");

      div.innerHTML=`
        <div class="legend-row">
          <input id="togglePoints" class="legend-checkbox" type="checkbox" checked>
          <span class="legend-dot"></span>
          <span class="legend-label">Observations</span>
        </div>
        <div class="legend-row">
          <input id="toggleGrid" class="legend-checkbox" type="checkbox" checked>
          <span class="legend-label"><b>Nombre d'observations</b></span>
        </div>
        <div class="legend-gradient"></div>
        <div class="legend-gradient-labels">
          <span>1</span><span>254</span>
        </div>
      `;

      L.DomEvent.disableClickPropagation(div);
      return div;
    };
    legend.addTo(map);

    // Gestion toggles
    document.addEventListener("change",(e)=>{
      if(e.target.id==="togglePoints") e.target.checked?map.addLayer(clusterGroup):map.removeLayer(clusterGroup);
      if(e.target.id==="toggleGrid" && gridLayer) e.target.checked?map.addLayer(gridLayer):map.removeLayer(gridLayer);
    });
  </script>
</body>
</html>


